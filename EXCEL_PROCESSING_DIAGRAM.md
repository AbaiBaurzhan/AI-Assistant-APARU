# Диаграмма процесса обработки Excel базы данных

## 🔄 Полный цикл обработки

```
📥 Excel файл (data/faq.xlsx)
    ↓
🔍 Валидация и очистка
    ├── Проверка существования файла
    ├── Проверка обязательных колонок (question, answer)
    ├── Удаление пустых строк
    ├── Удаление дубликатов
    └── Нормализация текста
    ↓
🤖 Генерация эмбеддингов
    ├── Загрузка модели BAAI/bge-m3
    ├── Нормализация вопросов
    ├── Пакетная обработка (32 текста за раз)
    └── Создание векторов размерности 1024
    ↓
🗂️ Построение FAISS индекса
    ├── Создание IndexFlatIP
    ├── L2 нормализация векторов
    ├── Добавление в индекс
    └── Сохранение в data/faiss.index
    ↓
💾 Сохранение базы знаний
    ├── Создание JSONL файла
    ├── Добавление метаданных (id, normalized_question)
    └── Сохранение в data/kb.jsonl
    ↓
🚀 Инициализация поискового движка
    ├── Загрузка модели эмбеддингов
    ├── Загрузка FAISS индекса
    ├── Загрузка базы знаний
    └── Готовность к поиску
    ↓
🔎 Поиск ответов
    ├── Нормализация запроса пользователя
    ├── Генерация эмбеддинга запроса
    ├── Поиск в FAISS индексе
    ├── Обработка результатов по порогам уверенности
    └── Возврат ответа пользователю
```

## 📊 Детальная схема обработки данных

### Этап 1: Входные данные

```
Excel файл (faq.xlsx)
├── Колонка "question" (вопросы)
├── Колонка "answer" (ответы)
└── Опциональная колонка "id"
```

### Этап 2: Очистка данных

```
Исходные данные
    ↓
Удаление пустых строк
    ↓
Удаление дубликатов
    ↓
Нормализация текста
    ├── Приведение к нижнему регистру
    ├── Удаление лишних пробелов
    └── Стандартизация формата
    ↓
Готовые к обработке данные
```

### Этап 3: Генерация эмбеддингов

```
Текст вопроса
    ↓
Модель BAAI/bge-m3
    ├── Токенизация
    ├── Обработка через transformer
    └── Создание вектора размерности 1024
    ↓
Векторное представление
```

### Этап 4: Построение индекса

```
Массив эмбеддингов
    ↓
FAISS IndexFlatIP
    ├── L2 нормализация
    ├── Добавление векторов
    └── Индексирование для быстрого поиска
    ↓
Готовый индекс (faiss.index)
```

### Этап 5: Сохранение базы знаний

```
DataFrame с данными
    ↓
JSONL формат
    ├── ID: q001, q002, q003...
    ├── question: оригинальный вопрос
    ├── answer: ответ
    └── normalized_question: нормализованный вопрос
    ↓
Файл kb.jsonl
```

## 🔍 Схема поиска

### Процесс поиска ответа

```
Запрос пользователя
    ↓
Нормализация запроса
    ↓
Генерация эмбеддинга запроса
    ↓
Поиск в FAISS индексе
    ├── Косинусное сходство
    ├── Топ-K результатов
    └── Индексы лучших совпадений
    ↓
Обработка результатов
    ├── confidence ≥ 0.8 → Точный ответ
    ├── 0.6 ≤ confidence < 0.8 → Уточнение
    └── confidence < 0.6 → Fallback приветствие
    ↓
Ответ пользователю
```

## 📈 Временные характеристики

### Время обработки (для 1000 записей):

```
Чтение Excel файла:     ~100ms
Генерация эмбеддингов:  ~2-5 секунд
Построение FAISS:       ~50ms
Сохранение файлов:      ~20ms
─────────────────────────────────
Общее время:            ~3-6 секунд
```

### Время поиска:

```
Нормализация запроса:   ~1ms
Генерация эмбеддинга:  ~10ms
Поиск в FAISS:         ~1-5ms
Обработка результатов: ~1ms
─────────────────────────────────
Общее время поиска:    ~13-17ms
```

## 🎯 Пороги уверенности

### Логика принятия решений:

```
confidence ≥ 0.8
    ↓
Высокая уверенность
    ├── Возврат точного ответа
    ├── source: q001, q002...
    └── similar_questions: []

0.6 ≤ confidence < 0.8
    ↓
Средняя уверенность
    ├── Запрос уточнения
    ├── source: null
    └── similar_questions: [список похожих]

confidence < 0.6
    ↓
Низкая уверенность
    ├── Fallback приветствие
    ├── source: fallback_greeting
    └── similar_questions: []
```

## 🔧 Компоненты системы

### Основные модули:

```
utils/excel_converter.py
├── ExcelToVectorDBConverter
├── read_excel_file()
├── normalize_text()
├── generate_embeddings()
├── build_faiss_index()
└── save_knowledge_base()

utils/search.py
├── SearchEngine
├── initialize()
├── find_best_answer()
├── process_search_results()
└── load_knowledge_base()

build_index.py
└── main() - точка входа для построения индекса
```

### Файлы данных:

```
data/
├── faq.xlsx          # Исходный Excel файл
├── faiss.index       # FAISS индекс для поиска
├── kb.jsonl          # База знаний в JSONL формате
└── feedback.log      # Логи обратной связи
```

## 🚀 Результат

После полной обработки Excel файла система получает:

1. **Оптимизированный индекс** для быстрого поиска
2. **Векторные представления** всех вопросов
3. **Нормализованную базу знаний** в JSONL формате
4. **Готовую поисковую систему** для ответов пользователям

**Система готова к работе с высокой точностью и производительностью!** 🎉
